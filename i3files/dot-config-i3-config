# -*- Mode: Shell-script -*-
#

# i3 config file (v4.16.1 on Xubuntu 16.04 LTS)
#
# Please see http://i3wm.org/docs/userguide.html for a complete reference!

#
# VARIABLES
#

# Helpers. Embedding the path explicitly is belt and braces.
set $default exec --no-startup-id ~/local/bin/i3-mode default
set $i3apps exec --no-startup-id ~/local/bin/i3-apps
set $i3display exec --no-startup-id ~/local/bin/i3-display
set $i3keyboard exec --no-startup-id ~/local/bin/i3-keyboard
set $i3make exec --no-startup-id ~/local/bin/i3-make
set $i3mode exec --no-startup-id ~/local/bin/i3-mode
set $i3mouse exec --no-startup-id ~/local/bin/i3-mouse
set $i3wrapper exec --no-startup-id ~/local/bin/i3-wrapper

set $defaultnop nop
set $primarynop nop
set $secondarynop nop

# Use 'xrandr' with no arguments to list monitor names and geometry.
# The values need not be mutually exclusive, but must be assigned.  I
# once had three monitors but now I have but two; nevertheless the
# following still works.
set $lmon HDMI2
set $cmon HDMI1
set $rmon VGA1

# Type 'pacmd list sinks' to list audio outputs. I use an HDMI to DVI
# cable from PC to monitor, it carries only video. To get audio the
# simplest method is to use the rear headphone jack.
set $analogaudiosink alsa_output.pci-0000_00_1b.0.analog-stereo
set $hdmiaudiosink alsa_output.pci-0000_00_03.0.hdmi-stereo
# Type 'pacmd list sources' to list audio inputs. One microphone
# lives in my webcam, the other in my headset / headphones.
set $webcamaudiosource alsa_input.usb-Alcor_Micro__Corp._TeckNet-02.analog-mono
set $analogaudiosource alsa_input.pci-0000_00_1b.0.analog-stereo

# The font used in i3-input prompt+command boxes.
# Forward declaration because used in various bindings.
set $i3inputfont "pango:DejaVu Sans 12"

# Symlink this.
set $i3keybindings /dev/shm/EllaTheCat/i3/bindings

# Using autologin on ansible ensured synergy communications but lacks
# security away from the office, hence this on ansible, and hence here.
set $i3lock exec --no-startup-id /usr/bin/i3lock  -c 000000 \
    -i /home/shevek/Pictures/i3lockimage.png

#
# BINDINGS
#

# Mod4 is the Windows key. Mod1 is the Alt key.

# Menu is a design decision please do not change.
# Menu can be generated by a modifier key using 'xcape'.
# I have used 'xcape' to bind Super_L to Menu for the left hand.
# Pressing cycles through the three modes. Def->Pri->Sec->Def.
bindsym Menu $i3mode Primary

# The command prompt is TAB in Primary & Secondary modes.
# This bindng may be easier even though it uses a modifier.
bindsym Mod4+Tab $i3wrapper -p

# Focus the next mark in a circular list of secondary marks.
# There are two lists of length 3 and one list of length 4.
bindsym Control+Tab $i3wrapper --cycle-through-marks

# i3-make installs the configuration files kept under a single
# directory under git into their runtime locations, and where
# necessary, reloads i3 config or restarts i3. The Makefile is
# supplied, the user modifies the example i3-make.
bindsym Control+Menu $i3make

# Control-Alt-Delete is a design decision please do not change.
bindsym Control+Mod1+Delete kill
bindsym Control+Mod4+Delete [workspace="__focused__"] kill

# A key chord to toggle the scratchpad terminal.
# This key chord works for my right hand.
bindsym Control+Delete $i3wrapper dd

# In default mode, this facilitates move and resize using the mouse
# without having to precisely position the mouse on window edges.
floating_modifier Mod4

# The modifier used with the arrow keys.
set $i3arrowmodifier Mod4

# Modifiers can be the better choice sometimes. My right hand is
# better resting by the arrows because of tremor.
bindsym $i3arrowmodifier+Left focus left
bindsym $i3arrowmodifier+Down focus down
bindsym $i3arrowmodifier+Up focus up
bindsym $i3arrowmodifier+Right focus right

# Numpad cursor controls (highly recommended).
# These should also be bound in Primary and Secondary modes.
bindsym KP_Left focus left
bindsym KP_Right focus right
bindsym KP_Home focus output $lmon
bindsym KP_Up focus output $cmon
bindsym KP_Prior focus output $rmon
bindsym KP_End move left
bindsym KP_Down move down
bindsym KP_Begin move up
bindsym KP_Next move right
bindsym KP_Delete $defaultnop

# Command prompt.
# The numpad enters numbers during command entry.
# Do not rebind KP_0, KP_1 ... KP_8, KP_9, KP_Decimal.
bindsym KP_Insert $default, $i3wrapper -p

# Numpad keys that are unaffected by the NumLock state.
# There are five: arithmetic signs / * - + and the enter key.
# Do not rebind KP_Enter! This is a design decision.
bindsym KP_Divide workspace prev_on_output
bindsym KP_Multiply workspace next_on_output

# Microphone muting (for privacy and phone conferencing).
# The i3bar displays the status of the two microphones:
# 0 == muted; 1 == not muted == a "hot" microphone.
# These are NOT bound in Primary or Secondary modes.
bindsym KP_Subtract \
        exec --no-startup-id pactl set-source-mute $analogaudiosource toggle
bindsym KP_Add \
        exec --no-startup-id pactl set-source-mute $webcamaudiosource toggle

#
# MODES
#

# Regarding Primary and Secondary modes, some bindings automatically
# change mode, typically returning to default mode. Convenience beats
# consistency. YMMV.

# Primary mode.
mode "Primary" {

    # Add a single letter mark. See also secondary mode.
    # These number bindings map to single letter marks.
    # Consider using i3-input and typing the letter.
    bindsym 1 $default, mark --add A
    bindsym 2 $default, mark --add B
    bindsym 3 $default, mark --add C
    bindsym 4 $default, mark --add R
    bindsym 5 $default, mark --add S
    bindsym 6 $default, mark --add T
    bindsym 7 $default, mark --add W
    bindsym 8 $default, mark --add X
    bindsym 9 $default, mark --add Y
    bindsym 0 $default, mark --add Z

    # This is independent of the similarly named configuration setting.
    bindsym q $default, workspace back_and_forth

    # (W)orkspace.
    bindsym w  \
        $default, exec i3-input -f $i3inputfont  -l 2 \
        -P '(workspace): ' -F 'workspace "%s"'

    # (R)ename a workspace.
    bindsym r \
        $default, exec i3-input -f $i3inputfont -l 2 \
        -P '(rename this workspace to): ' \
        -F 'rename workspace to "%s"'

    # [T]abbed layout.
    bindsym t $default, layout tabbed

    # Focus the workspace with the latest [u]rgency hint.
    bindsym u $default, [urgent=latest] focus

    # Focus the child container.
    bindsym o focus child
    # Focus the (P)arent container.
    bindsym p focus parent

    bindsym e $primarynop
    bindsym y $primarynop

    # Info on keyboard bindings.
    bindsym i $default, $i3wrapper --keyboard-binding-info

    # Scratchpad (exclude the scratchpad terminal which is a special case).
    bindsym bracketleft move scratchpad
    bindsym bracketright scratchpad show

    # Command prompt.
    bindsym Tab $default, $i3wrapper -p

    # Toggle a side-by-side pair to one-above-the-other.
    # A for Above.
    bindsym a $default, focus right, split v, focus left, move right, move up ;
    # Toggle a one-above-the-other pair to side-by-side.
    # S for Side by Side.
    bindsym s $default, focus down, split h, focus up, move down, move left;

    # Tiled containers are the default.
    bindsym d $default, layout default

    # Enter fullscreen mode for the focused container.
    bindsym f $default, fullscreen toggle
    bindsym g $default, fullscreen toggle global

    # Increase or decrease the height or width symmetrically.
    # I orient myself by how the border separating windows moves.
    # Consider swapping the HL or JK directions if not to your liking.
    bindsym h resize grow right 6 px or 1 ppt, resize grow left 6 px or 1 ppt
    bindsym j resize shrink down 6 px or 1 ppt, resize shrink up 6 px or 1 ppt
    bindsym k resize grow up 6 px or 1 ppt, resize grow down 6 px or 1 ppt
    bindsym l resize shrink left 6 px or 1 ppt, resize shrink right 6 px or 1 ppt

    # Toggle between being a tiled|floating window.
    # Toggle focus between tiled|floating windows.
    bindsym semicolon floating toggle
    bindsym apostrophe focus mode_toggle

    bindsym backslash $default, $i3wrapper -p

    # Move workspace to another output.
    bindsym z $default, move workspace to output $lmon
    bindsym x $default, move workspace to output $cmon
    bindsym c $default, move workspace to output $rmon

    # Split directions.
    bindsym v split v
    bindsym b split h

    bindsym n $primarynop

    # (M)ove container to named workspace.
    bindsym m \
       $default, exec i3-input -f $i3inputfont  -l 2 \
        -P '(move container to workspace): ' \
        -F 'move container to workspace "%s"'

    bindsym comma $default, [title="AutoVoice Options"] focus
    bindsym period $default, move container to workspace AutoVoice
    bindsym slash $default, workspace AutoVoice

    # Control-*-Delete is a design decision please do not change.
    bindsym Control+Mod1+Delete $default,kill
    bindsym Control+Mod4+Delete [workspace="__focused__"] $default,kill

    bindsym $i3arrowmodifier+Left focus left
    bindsym $i3arrowmodifier+Down focus down
    bindsym $i3arrowmodifier+Up focus up
    bindsym $i3arrowmodifier+Right focus right

    # Numpad cursor keys copied from default mode.
    bindsym KP_Left focus left
    bindsym KP_Right focus right
    bindsym KP_Home focus output $lmon
    bindsym KP_Up focus output $cmon
    bindsym KP_Prior focus output $rmon
    bindsym KP_End move left
    bindsym KP_Down move down
    bindsym KP_Begin move up
    bindsym KP_Next move right
    bindsym KP_Delete $primarynop
    bindsym KP_Insert $default, $i3wrapper -p

    # Numpad keys that are unaffected by the NumLock state.
    # There are five: arithmetic signs / * - + and the enter key.
    # Do not rebind KP_Enter! This is a design decision.
    bindsym KP_Divide workspace prev_on_output
    bindsym KP_Multiply workspace next_on_output

    # Eye candy. KP_Add increases translucency. KP_Subtract will not
    # set opacity beyond 100%, hence using keyboard autorepeat will
    # safely make the window opaque.
    bindsym KP_Subtract \
            exec --no-startup-id compton-trans -c -o +10
    bindsym KP_Add \
            exec --no-startup-id compton-trans -c -o -10

    bindsym Return $default, $i3lock

    # Pressing cycles through the three modes. Pri->Sec->Def->Pri.
    bindsym Menu mode "Secondary"
    # Go back to normal. Using space is a design decision, please do
    # not change.
    bindsym space $default
}

# Secondary Mode.
# Entered from primary mode using Menu.
# Keyboard & Mouse. Display & Desktop. USB drives.
mode "Secondary" {

    # Remove a single letter mark. See also primary mode.
    bindsym 1 $default, unmark A
    bindsym 2 $default, unmark B
    bindsym 3 $default, unmark C
    bindsym 4 $default, unmark R
    bindsym 5 $default, unmark S
    bindsym 6 $default, unmark T
    bindsym 7 $default, unmark W
    bindsym 8 $default, unmark X
    bindsym 9 $default, unmark Y
    bindsym 0 $default, unmark Z
    # Remove an entire group of single letter marks.
    bindsym grave $default, \
            unmark A, unmark B, unmark C
    bindsym minus $default, \
            unmark R, unmark S, unmark T
    bindsym equal $default, \
            unmark W, unmark X,  unmark Y, unmark Z

    bindsym q $default, workspace back_and_forth

    # These {w,e,r} keys are adjacent to the complementary {s,d,f}
    # keys, and apart from 'r' match the first letter of the argument.
    bindsym w $default, $i3display wake
    bindsym e $default, $i3mouse enable
    bindsym r $default, $i3mouse slow

    bindsym t $secondarynop
    bindsym y $secondarynop

    # My quietpc has attached USB drives 1 Tbyte & 4 Tbyte.
    # Spin both down, blue LEDs should stay dark when quietpc is off.
    bindsym u $default, $i3apps stop usbdisks

    bindsym i $secondarynop
    bindsym o $secondarynop

    # Benq DVI and HDMI auto-switching to save wear & tear.
    # https://raspberrypi.stackexchange.com/a/53267
    bindsym p $default, $i3display menu

    # Command prompt.
    bindsym Tab $default, $i3wrapper -p

    bindsym a $secondarynop

    # Complementary to the {w,e,r} keys, see above.
    bindsym s  $default, $i3display sleep
    bindsym d $default, $i3mouse disable
    bindsym f $default, $i3mouse fast

    bindsym g $secondarynop
    bindsym h $secondarynop
    bindsym j $secondarynop

    # Set modifiers with 'xcape', set CapsLock to Control,
    # mimic US layout on UK keyboard, but not keyclick.
    bindsym k $default, $i3keyboard

    bindsym l $secondarynop

    bindsym backslash $default, $i3wrapper -p

    # Focus watcher start and stop.
    bindsym z $default, $i3apps start focuswatcher
    bindsym x $default, $i3apps stop focuswatcher

    # Audible keyclicks require audio to be routed to speakers,
    # my setup doesn't enforce this (when watching TV).
    bindsym c $default, exec --no-startup-id keyclick

    bindsym v $default,$i3mouse window
    bindsym b $default,$i3mouse desktop

    # Desktop background.
    bindsym n $default, exec --no-startup-id nitrogen --restore

    # File watcher start. Seldom required, crashes are extremely rare.
    bindsym m $default, $i3apps start filewatcher

    # Focus a window, warp the mouse inside the window, or not.
    bindsym comma $default, $i3mouse window
    bindsym period $default, $i3mouse desktop

    # File watcher stop binding is RESERVED and DEPRECATED.
    bindsym slash $secondarynop

    # Control-*-Delete is a design decision please do not change.
    # Kill a window, kill a workspace, close a session.
    bindsym Control+Mod1+Delete $default,kill
    bindsym Control+Mod4+Delete [workspace="__focused__"] $default, kill
    bindsym Control+Mod4+Mod1+Delete  $default, $i3apps stop everything

    bindsym $i3arrowmodifier+Left focus left
    bindsym $i3arrowmodifier+Down focus down
    bindsym $i3arrowmodifier+Up focus up
    bindsym $i3arrowmodifier+Right focus right

    # Numpad cursor keys copied from default mode.
    bindsym KP_Left focus left
    bindsym KP_Right focus right
    bindsym KP_Home focus output $lmon
    bindsym KP_Up focus output $cmon
    bindsym KP_Prior focus output $rmon
    bindsym KP_End move left
    bindsym KP_Down move down
    bindsym KP_Begin move up
    bindsym KP_Next move right
    bindsym KP_Delete $secondarynop
    bindsym KP_Insert $default, $i3wrapper -p

    # Numpad keys that are unaffected by the NumLock state.
    # There are five: arithmetic signs / * - + and the enter key.
    # Do not rebind KP_Enter! This is a design decision.
    bindsym KP_Divide workspace prev_on_output
    bindsym KP_Multiply workspace next_on_output

    # Subject to change: volume control of 3.5mm rear line out.
    # Beware! Increasing beyond 100% can damage speakers.
    bindsym KP_Subtract \
            exec pactl set-sink-volume $analogaudiosink -10%
    bindsym KP_Add \
            exec pactl set-sink-volume $analogaudiosink +10%

    # Pressing cycles through the three modes. Sec->Def->Pri->Sec.
    # Triple-pressing(!) in default mode enables mouse in Emacs.
    bindsym Menu $default, $i3wrapper --toggle-emacs-mouse
    # Go back to normal. Using space is a design decision, please do
    # not change.
    bindsym space $default
}

# OK mode.
# This mode exists only to use the mode indicator as a visual bell.
mode "OK" {
    bindsym Menu $default
    bindsym space $default
}

#
# SETTINGS
#

# Do not set this to yes. The toggling behaviour this would provide is
# described in the User Guide and is not my cup of tea. Setting 'no'
# does not preclude a ' toggle workspaces' key binding that works.
workspace_auto_back_and_forth no

# Status to the side.
workspace "wm" output $lmon

# Media to the side.
workspace "tv" output $lmon
workspace "mp" output $lmon
workspace "fp" output $lmon
workspace "vp" output $lmon

# Emacs and Chrome on complementary outputs.
workspace "e0" output $cmon
workspace "e1" output $cmon
workspace "e2" output $cmon
workspace "e3" output $cmon

workspace "g0" output $lmon
workspace "g1" output $lmon
workspace "g2" output $lmon
workspace "g3" output $lmon

# As above for [0:3] but swapped for [4:7].
workspace "e4" output $lmon
workspace "e5" output $lmon
workspace "e6" output $lmon
workspace "e7" output $lmon

workspace "g4" output $cmon
workspace "g5" output $cmon
workspace "g6" output $cmon
workspace "g7" output $cmon

# Assign applications to workspaces.
# Use this method when launching applications indirectly.
# For example tvheadend calls mpv automatically.
assign [instance="xfce4-terminal" title="watcher$"] wm
assign [instance="xfce4-terminal" title="tvheadend"] tv
assign [instance="gl" class="mpv"]  mp
assign [title="VLC media player$"] vp
assign [title="Meld$"] md
assign [instance="wireshark"]  ws
assign [title="DVB Inspector"] di
assign [title="Clementine"] mu

# Windows that look'n'feel better when floating.
for_window [instance="dtvkit"] floating enable;
for_window [instance="xfce4-notifyd$"] floating enable;
for_window [instance="yad"] floating enable;
for_window [title="Bluetooth Devices"] floating enable;
for_window [title="Cheese"] floating enable;
for_window [title="Do Not Panic"] floating enable;
for_window [title="File Operation Progress"] floating enable;
for_window [title="Scratchpad"] floating enable;
for_window [title="Unlock Keyring"] floating enable;
for_window [class="ffplay"] floating enable;

# Mark application windows with a 2 digit number.
for_window [instance="xfce4-terminal"] $i3wrapper --unique-mark;
for_window [instance="emacs"] $i3wrapper --unique-mark;
for_window [class="Google-chrome"] $i3wrapper --unique-mark;

# VirtualBox windows assume full screen dimensions.
for_window [title="VirtualBox Manager"] layout tabbed;
for_window [title="Software Updater"] fullscreen enable;
for_window [title="Meld$"] layout tabbed;

# Windows to hide.
for_window [title="KeyClick"] move scratchpad;

# Windows that annoy me, that I can't fix.
for_window [title="Add Security Exception"] kill;

# Colours for windows.
# Defaults changed to green title bar and border when focused.
# class | border | background | text | indicator | child_border
client.focused          #333333 #006600 #ffffff #2e9ef4   #185522
client.focused_inactive #333333 #333311 #bbbbbb #484e50   #5f676a
client.unfocused        #333333 #444444 #bbbbbb #292d2e   #222222
client.urgent           #880000 #444444 #ffffff #880000   #900000
client.placeholder      #000000 #0c0c0c #ffffff #000000   #0c0c0c

# Font for window titles. The font for the bar is set explicitly.
font pango:DejaVu Sans 11

# Start i3bar to display a workspace bar (plus the system information i3status
# finds out, if available)
bar {
    # Show the bar on the 1920x1080 screens but not on the 1280x1024
    # screen for better alignment.
    output $lmon
    output $cmon
    i3bar_command /usr/bin/i3bar
    position bottom
    status_command ~/local/bin/i3-status --config ~/.config/i3status/config
    tray_output $cmon
    font pango:DejaVu Sans 11
    # Bar related actions only please.
    # The wallpaper attribution notice can be requested at any time.
    bindsym button2 $default, [urgent=latest] focus
    bindsym button3 $default, $i3apps start wallpaper
}

# Mouse behaviour wrt windows.
focus_follows_mouse no
# Focus Up can Focus Down because there are seldom more than three
# windows stacked vertically.
focus_wrapping force

# Additional Menu and Escape keys. US layout on UK PC105. 'keycode
# 51' is mapped to Return to mimic the geometry of the US keyboard.
# Stuck modifiers are cleared.
$i3keyboard

# Mouse warping default (see key bindings).
$i3mouse desktop

# Microphones' defaults (see key bindings). 1 = mute here.
exec --no-startup-id pactl set-source-mute $analogaudiosource 1
exec --no-startup-id pactl set-source-mute $webcamaudiosource 1

# Put the "i3-nagbar" on the primary monitor.
exec --no-startup-id xrandr --output $cmon --primary &

# Compton. As per manpage requires (~/.config/compton.conf).
# Desktop background (for empty workspaces).
# https://faq.i3wm.org/question/6/how-can-i-set-a-desktop-background-image-in-i3/
# The 10 second delay between starting compton and applying the
# desktop background avoids screen corruption on my machine.
exec --no-startup-id compton -b &
exec --no-startup-id sleep 10s && nitrogen --restore &

# Try to ensure dropbox starts cleanly without impacting anything else.
exec --no-startup-id dropbox stop &
exec --no-startup-id sleep 1.5 && killall --quiet dropbox &
exec --no-startup-id sleep 3 && dbus-launch dropbox start -i &
# Try to ensure xfce4-panel starts once only lest dialogs appear.
exec --no-startup-id xfce4-panel

# Applications.
# The 10 second delay ensures that the dialog appears after the
# desktop background changes.
exec --no-startup-id sleep 10s && ~/local/bin/i3-apps start everything

#
# Done
#
