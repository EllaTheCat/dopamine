# -*- Mode: Shell-script -*-
#
# i3 config file (v4)
# i3 v4.17.1 on Xubuntu 16.04 LTS on quietpc
# Please see http://i3wm.org/docs/userguide.html for a complete reference!

#
# VARIABLES
#

# This is secure enough to deter casual intruders.
set $i3lock /usr/bin/i3lock \
    --ignore-empty-password \
    -c 000000 \
    -i ~/Pictures/i3lockimage.png
# Automatic login with lightdm allows this machine to act as a PVR,
# hence this:
exec --no-startup-id $i3lock

# Helpers. Embedding the path explicitly is belt and braces.
set $default exec --no-startup-id ~/local/bin/i3-mode default
set $i3apps exec --no-startup-id ~/local/bin/i3-apps
set $i3display exec --no-startup-id ~/local/bin/i3-display
set $i3keyboard exec --no-startup-id ~/local/bin/i3-keyboard
set $i3keyclick exec --no-startup-id ~/local/bin/i3-keyclick
set $i3make exec --no-startup-id ~/local/bin/i3-make
set $i3mode exec --no-startup-id ~/local/bin/i3-mode
set $i3mouse exec --no-startup-id ~/local/bin/i3-mouse
set $i3powermate exec --no-startup-id ~/local/bin/i3-powermate
set $i3tasker exec --no-startup-id ~/local/bin/i3-tasker
set $i3wrapper exec --no-startup-id ~/local/bin/i3-wrapper

set $defaultnop nop
set $primarynop nop
set $secondarynop nop

# Use 'xrandr' with no arguments to list monitor names and geometry.
# The values need not be mutually exclusive, but must be assigned.  I
# once had three monitors but now I have but two; nevertheless the
# following still works.
set $lmon HDMI2
set $cmon HDMI1
set $rmon VGA1

# Type 'pacmd list sinks' to list audio outputs. I use an HDMI to DVI
# cable from PC to monitor, it carries only video. To get audio the
# simplest method is to use the rear headphone jack.
set $analogaudiosink alsa_output.pci-0000_00_1b.0.analog-stereo
set $bluetoothaudiosink bluez_sink.00_01_01_00_12_CB
set $hdmiaudiosink alsa_output.pci-0000_00_03.0.hdmi-stereo
set $usbaudiosink alsa_output.usb-C-Media_Electronics_Inc._USB_Audio_Device-00.analog-stereo
# Type 'pacmd list sources' to list audio inputs.
set $webcamaudiosource alsa_input.usb-Alcor_Micro__Corp._TeckNet-02.analog-mono
set $analogaudiosource alsa_input.pci-0000_00_1b.0.analog-stereo
set $usbaudiosource alsa_input.usb-C-Media_Electronics_Inc._USB_Audio_Device-00.analog-mono

# The font used in i3-input prompt+command boxes.
# Forward declaration because used in various bindings.
set $i3inputfont "pango:DejaVu Sans 12"

# Symlink this.
set $i3keybindings /dev/shm/EllaTheCat/i3/bindings

#
# BINDINGS
#

# Mod4 is the Windows key. Mod1 is the Alt key.

# Menu is a design decision please do not change.
# Menu can be generated by a modifier key using 'xcape'.
# I have used 'xcape' to bind Super_L to Menu for the left hand.
# Pressing cycles through the three modes. Def->Pri->Sec->Def.
bindsym Menu $i3mode Primary

# The command prompt is TAB in Primary & Secondary modes.
# This bindng may be easier even though it uses a modifier.
bindsym Mod4+Tab $i3wrapper -p

# Focus the next mark in a circular list of secondary marks.
# There are two lists of length 3 and one list of length 4.
bindsym Control+Tab $i3wrapper --cycle-through-marks

# i3-make installs the configuration files kept under a single
# directory under git into their runtime locations, and where
# necessary, reloads i3 config or restarts i3. The Makefile is
# supplied, the user modifies the example i3-make.
bindsym Control+Menu $i3make

# Kill a window, kill a workspace.
bindsym Control+Mod1+Delete kill
bindsym Control+Mod4+Delete [workspace="__focused__"] kill

# A key chord to toggle the scratchpad terminal.
# This key chord works for my right hand.
bindsym Control+Delete $i3wrapper dd

# Disable DPMS with a safe key.
bindsym Pause exec --no-startup-id xset -dpms
# Facilitate marking windows.
bindsym Print $i3wrapper --unique-mark

# In default mode, this facilitates move and resize using the mouse
# without having to precisely position the mouse on window edges.
floating_modifier Mod4

# The modifier used with the arrow keys.
set $i3arrowmodifier Mod4

# Modifiers can be the better choice sometimes.
bindsym $i3arrowmodifier+Left focus left
bindsym $i3arrowmodifier+Down focus down
bindsym $i3arrowmodifier+Up focus up
bindsym $i3arrowmodifier+Right focus right

# Numpad cursor controls (highly recommended).
bindsym KP_Left focus left
bindsym KP_Right focus right
bindsym KP_Home focus output $lmon
bindsym KP_Up focus output $cmon
bindsym KP_Prior focus output $rmon
bindsym KP_End move left
bindsym KP_Down move down
bindsym KP_Begin move up
bindsym KP_Next move right

# Command prompt.
# The numpad enters numbers during command entry.
# Do not rebind KP_0, KP_1 ... KP_8, KP_9, KP_Decimal.
bindsym KP_Insert $i3wrapper -p

# Numpad keys that are unaffected by the NumLock state.
# There are five: arithmetic signs / * - + and the enter key.
# Do not rebind KP_Enter! This is a design decision.
bindsym KP_Divide workspace prev_on_output
bindsym KP_Multiply workspace next_on_output

# Microphone muting (for privacy and phone conferencing).
# The i3bar displays the status of up to three microphones:
# 0 == muted; 1 == not muted == a "hot" microphone.
# These are NOT bound in Primary or Secondary modes.
# - USB adapter audio is reserved for Skype.
# - Analog audio is reserved for Google including Autovoice.
# - Webcam audio is supported.
bindsym KP_Subtract \
        exec --no-startup-id pactl set-source-mute $usbaudiosource toggle
bindsym KP_Add \
        exec --no-startup-id pactl set-source-mute $analogaudiosource toggle
bindsym KP_Delete \
        exec --no-startup-id pactl set-source-mute $webcamaudiosource toggle

#
# MODES
#

# Regarding Primary and Secondary modes, some bindings automatically
# change mode, typically returning to default mode. Convenience beats
# consistency. YMMV.

# Primary mode.
# Use this mode for window management, not settings.
mode "Primary" {

    # Add a single letter mark. See also secondary mode.
    # These number bindings map to single letter marks.
    # Consider using i3-input and typing the letter.
    bindsym 1 $default, mark --add --toggle A
    bindsym 2 $default, mark --add --toggle B
    bindsym 3 $default, mark --add --toggle C
    bindsym 4 $default, mark --add --toggle R
    bindsym 5 $default, mark --add --toggle S
    bindsym 6 $default, mark --add --toggle T
    bindsym 7 $default, mark --add --toggle W
    bindsym 8 $default, mark --add --toggle X
    bindsym 9 $default, mark --add --toggle Y
    bindsym 0 $default, mark --add --toggle Z

    # Remove an entire group of single letter marks.
    # These are on the same row as the digits.
    bindsym grave $default, \
            unmark A, unmark B, unmark C
    bindsym minus $default, \
            unmark R, unmark S, unmark T
    bindsym equal $default, \
            unmark W, unmark X, unmark Y, unmark Z

    # This is independent of the similarly named configuration setting.
    bindsym q $default, workspace back_and_forth

    # (W)orkspace.
    bindsym w  \
            $default, exec i3-input -f $i3inputfont  -l 2 \
            -P '(workspace): ' -F 'workspace "%s"'

    # A dmenu showing window titles and their associatef marks.
    # The use case is finding the title a mark is associated with.
    # Selecting an item visits the mark.
    bindsym e $default, $i3wrapper --visit-mark

    # (R)ename a workspace.
    bindsym r \
            $default, exec i3-input -f $i3inputfont -l 2 \
            -P '(rename this workspace to): ' \
            -F 'rename workspace to "%s"'

    # Launch a terminal. The 'tt' and 'yy' commands are deprecated.
    bindsym t $default, split h, exec xfce4-terminal -T "xfce4-terminal" &
    bindsym y $default, split v, exec xfce4-terminal -T "xfce4-terminal" &

    # Focus the workspace with the latest [u]rgency hint.
    bindsym u $default, [urgent=latest] focus

    # [I]nfo on keyboard bindings.
    bindsym i $default, $i3make, $i3wrapper --keyboard-binding-info

    # P for Parent. O for Offspring.
    bindsym o focus child
    bindsym p focus parent

    # Scratchpad (exclude the scratchpad terminal which is a special case).
    bindsym bracketleft move scratchpad
    bindsym bracketright scratchpad show

    # Command prompt.
    bindsym Tab $default, $i3wrapper -p

    # Toggle a side-by-side pair to one-above-the-other.
    # A for Above.
    bindsym a $default, focus right, split v, focus left, move right, move up ;
    # Toggle a one-above-the-other pair to side-by-side.
    # S for Side by Side.
    bindsym s $default, focus down, split h, focus up, move down, move left;

    # Tiled containers are the [d]efault.
    bindsym d $default, layout default

    # Enter [f]ullscreen mode for the focused container.
    bindsym f $default, fullscreen toggle
    bindsym g $default, fullscreen toggle global

    # Increase or decrease the height or width symmetrically.
    # I orient myself by how the border separating windows moves.
    # Consider swapping the HL or JK directions if not to your liking.
    bindsym h resize grow right 6 px or 1 ppt, resize grow left 6 px or 1 ppt
    bindsym j resize shrink down 6 px or 1 ppt, resize shrink up 6 px or 1 ppt
    bindsym k resize grow up 6 px or 1 ppt, resize grow down 6 px or 1 ppt
    bindsym l resize shrink left 6 px or 1 ppt, resize shrink right 6 px or 1 ppt

    # Toggle between being a tiled|floating window.
    # Toggle focus between tiled|floating windows.
    bindsym semicolon floating toggle
    bindsym apostrophe focus mode_toggle

    bindsym Return $default, [workspace="phonecall1"] kill,  [workspace="phonecall2"] kill, \
            focus output HDMI1, workspace prev_on_output, \
            focus output HDMI2, workspace prev_on_output;

    bindsym backslash $default, $i3wrapper -p

    # Move workspace to another output.
    bindsym z $default, move workspace to output $lmon
    bindsym x $default, move workspace to output $cmon
    bindsym c $default, move workspace to output $rmon

    # Split directions.
    bindsym v split v
    bindsym b split h

    # Place a unique two digit mark on the focused window's titlebar.
    # [u] and [m] are already in use. The mark is a two digit [n]umber.
    # The prompt doesn't work because it forgets where the focus was.
    bindsym n $default, $i3wrapper --unique-mark

    # (M)ove container to named workspace.
    bindsym m \
            $default, exec i3-input -f $i3inputfont  -l 2 \
            -P '(move container to workspace): ' \
            -F 'move container to workspace "%s"'

    bindsym comma $primarynop
    bindsym period $primarynop
    bindsym slash $primarynop

    # Simple focus keys similar to default mode.
    # YMMV but I prefer to omit the i3arrowmodifier here.
    bindsym Left focus left
    bindsym Down focus down
    bindsym Up focus up
    bindsym Right focus right

    # Numpad key binds are nearly identical to default mode.
    bindsym KP_Left focus left
    bindsym KP_Right focus right
    bindsym KP_Home focus output $lmon
    bindsym KP_Up focus output $cmon
    bindsym KP_Prior focus output $rmon
    bindsym KP_End move left
    bindsym KP_Down move down
    bindsym KP_Begin move up
    bindsym KP_Next move right
    bindsym KP_Insert $default, $i3wrapper -p

    # This toggles the AutoVoice for Chrome extension on-off.
    # It requres a Chrome instance running on workspace g9.
    # It breaks far too easily, don't change the window layout.
    bindsym KP_Delete \
            $i3tasker "i3_generic :autovoice continuous ${lmon}"

    # Numpad keys that are unaffected by the NumLock state.
    # There are five: arithmetic signs / * - + and the enter key.
    # Do not rebind KP_Enter! This is a design decision.
    bindsym KP_Divide workspace prev_on_output
    bindsym KP_Multiply workspace next_on_output

    # Eye candy. KP_Add increases translucency. KP_Subtract will not
    # set opacity beyond 100%, hence using keyboard autorepeat will
    # safely make the window opaque.
    bindsym KP_Subtract \
            exec --no-startup-id compton-trans -c -o +10
    bindsym KP_Add \
            exec --no-startup-id compton-trans -c -o -10

    # Pressing cycles through the three modes. Pri->Sec->Def->Pri.
    bindsym Menu mode "Secondary"
    # Go back to normal. Using space is a design decision, please do
    # not change.
    bindsym space $default
}

# Secondary Mode.
# Entered from primary mode using Menu.
# Keyboard & Mouse. Display & Desktop. USB drives.
# Use this mode for settings, not window management.
mode "Secondary" {

    # I'm not pressing keys hard enough to register. This script makes
    # an IBM PC clicky sound as feedback. It's in the dopamine (my git
    # repo) scripts folder. Mnemonic q often sounds like k.
    bindsym q $default, $i3keyclick

    # {w,e,r} {s,d,f} keys.
    bindsym w $default, $i3mouse window
    bindsym e $default, $i3mouse enable
    bindsym r $default, $i3mouse reset

    # [T]abbed layout.
    bindsym t $default, layout tabbed
    bindsym y $secondarynop

    # Spin down the USB drives attached to my desktop PC, their blue
    # LEDs should stay dark. One drive automatically spins down, one
    # drive only spins down when requested.
    bindsym i $secondarynop
    bindsym o $default, $i3apps stop usbdisks

    # Benq DVI and HDMI auto-switching to save wear & tear.
    # https://raspberrypi.stackexchange.com/a/53267
    bindsym p $default, $i3display menu

    # Command prompt.
    bindsym Tab $default, $i3wrapper -p

    # Select an audio output.
    bindsym a  $default, exec pactl move-sink-input \
            "$(pactl list short sink-inputs | awk '{print $1}')" $analogaudiosink ;
    bindsym h  $default, exec pactl move-sink-input \
            "$(pactl list short sink-inputs | awk '{print $1}')" $hdmiaudiosink ;
    bindsym b  $default, exec pactl move-sink-input \
            "$(pactl list short sink-inputs | awk '{print $1}')" $bluetoothaudiosink ;
    bindsym u  $default, exec pactl move-sink-input \
            "$(pactl list short sink-inputs | awk '{print $1}')" $usbaudiosink ;

    # {s,d,f} {w,e,r} keys.
    bindsym s $default, $i3mouse slow
    bindsym d $default, $i3mouse disable
    bindsym f $default, $i3mouse fast

    bindsym g $secondarynop
    bindsym j $secondarynop

    # Set modifiers with 'xcape', set CapsLock to Control,
    # mimic US layout on UK keyboard.
    bindsym k $default, $i3keyboard
    bindsym l $secondarynop

    bindsym Return $secondarynop

    # Command prompt.
    bindsym backslash $default, $i3wrapper -p

    # Focus is on output P, output Q shows workspace W, focus Q,
    # switch to Primary mode ready to move W to P using {z,x,c}.
    bindsym z focus output $lmon, mode Primary;
    bindsym x focus output $cmon, mode Primary;
    bindsym c focus output $rmon, mode Primary;

    # Volume Control (alias "pavucontrol", "Sound Settings..."),
    bindsym v $default, exec --no-startup-id pavucontrol

    # Desktop background.
    bindsym n $default, exec --no-startup-id nitrogen --restore

    bindsym m $secondarynop

    bindsym comma $secondarynop
    bindsym period $secondarynop
    bindsym slash $secondarynop

    # All monitors turn OFF.
    bindsym Pause $default, $i3display off

    # Close a session. Avoid window or workspace kill bindings here.
    bindsym Control+Mod4+Mod1+Delete  $default, $i3apps stop everything

    # Pressing cycles through the three modes. Sec->Def->Pri->Sec.
    bindsym Menu $default
    # Go back to normal. Using space is a design decision, please do
    # not change.
    bindsym space $default
}

# OK mode.
# This mode exists only to use the mode indicator as a visual bell.
mode "OK" {
    bindsym Menu $default
    bindsym space $default
}

#
# SETTINGS
#

# Do not set this to yes. The toggling behaviour this would provide is
# described in the User Guide and is not my cup of tea. Setting 'no'
# does not preclude a ' toggle workspaces' key binding that works.
workspace_auto_back_and_forth no

# Status to the side.
workspace "wm" output $lmon

# Media to the side.
workspace "tv" output $lmon
workspace "mp" output $lmon
workspace "fp" output $lmon
workspace "vp" output $lmon

# Emacs and Chrome.
workspace "e0" output $cmon
workspace "e1" output $cmon
workspace "e2" output $cmon
workspace "e3" output $cmon

workspace "g0" output $cmon
workspace "g1" output $cmon
workspace "g2" output $cmon
workspace "g3" output $cmon

# Assign applications to workspaces.
# Use this method when launching applications indirectly.
# For example tvheadend calls mpv automatically.
assign [instance="xfce4-terminal" title="watcher$"] wm
assign [instance="xfce4-terminal" title="SoundWireServer"] wm
assign [instance="xfce4-terminal" title="tvheadend"] tv
assign [class="mpv"]  mp
assign [title="VLC media player$"] vp
assign [title="Meld$"] md
assign [instance="wireshark"]  ws
assign [title="DVB Inspector"] di
assign [title="SM-G930F"] s7

# Windows that look'n'feel better when floating.
for_window [instance="dtvkit"] floating enable;
for_window [instance="xfce4-notifyd$"] floating enable;
for_window [instance="yad"] floating enable;
for_window [title="Bluetooth Devices"] floating enable;
for_window [title="Cheese"] floating enable;
for_window [title="Do Not Panic"] floating enable;
for_window [title="File Operation Progress"] floating enable;
for_window [title="Scratchpad"] floating enable;
for_window [title="Unlock Keyring"] floating enable;
for_window [class="ffplay"] floating enable;
for_window [title="Volume Control"] \
           floating enable, move absolute position 2400 48, \
           resize set 50 ppt 80 ppt;

# Application windows.
for_window [instance="xfce4-terminal"] $i3wrapper --unique-mark;
for_window [instance="emacs24"] $i3wrapper --unique-mark;
for_window [instance="google-chrome"] $i3wrapper --unique-mark;
for_window [instance="gl" class="mpv"] $i3wrapper --unique-mark;

# VirtualBox windows assume full screen dimensions.
for_window [title="VirtualBox Manager"] layout tabbed;
for_window [title="Software Updater"] layout tabbed;
for_window [title="Meld$"] layout tabbed;
for_window [title="Spotify"] layout tabbed;
for_window [title="Clementine"] layout tabbed;

# Windows to hide.
for_window [title="KeyClick"] move scratchpad;

# Windows that annoy me, that I can't fix.
for_window [title="Add Security Exception"] kill;

# Colours for windows. Defaults changed to better distinguish are:
# 1. green title bar and border when focused.
# 2. gold title bar when focused inactive,
# 3. grey title bar otherwise.
# class | border | background | text | indicator | child_border
client.focused          #333333 #008800 #ffffff #2e9ef4   #185522
client.focused_inactive #333333 #666600 #dddddd #484e50   #5f676a
client.unfocused        #333333 #444444 #bbbbbb #292d2e   #222222
client.urgent           #880000 #444444 #ffffff #880000   #900000
client.placeholder      #000000 #444444 #ffffff #000000   #0c0c0c

# Font for window titles. The font for the bar is set explicitly.
font pango:DejaVu Sans 11

# Start i3bar to display a workspace bar (plus the system information i3status
# finds out, if available)
bar {
    # Show the bar on the 1920x1080 screens but not on the 1280x1024
    # screen for better alignment.
    output $lmon
    output $cmon
    i3bar_command /usr/bin/i3bar
    position bottom
    status_command ~/local/bin/i3-status --config ~/.config/i3status/config
    tray_output $cmon
    font pango:DejaVu Sans 11
    # Bar related actions only please.
    # The wallpaper attribution notice can be requested at any time.
    bindsym button2 $default, [urgent=latest] focus
    bindsym button3 $default, $i3apps start wallpaper
}

# Mouse behaviour wrt windows. Prefer click-to-focus, default is no.
focus_follows_mouse no
# Focus wrapping isn't as simple as I was lead to believe.
focus_wrapping off

# Additional Menu and Escape keys. US layout on UK PC105. 'keycode
# 51' is mapped to Return to mimic the geometry of the US keyboard.
# Stuck modifiers are cleared.
$i3keyboard

# [reset] Mouse behaves normally. [window] Mouse warps to window.
$i3mouse reset

# AutoVoice Clipboard emacs buffer backing file.
exec --no-startup-id /usr/bin/touch /dev/shm/shevek/i3/Clipboard

# Microphones' defaults (see key bindings). 1 = mute here.
exec --no-startup-id pactl set-source-mute $usbaudiosource 1
exec --no-startup-id pactl set-source-mute $analogaudiosource 1
exec --no-startup-id pactl set-source-mute $webcamaudiosource 1

# Put the "i3-nagbar" on the primary monitor.
exec --no-startup-id xrandr --output $cmon --primary &

# Compton. As per manpage requires (~/.config/compton.conf).
# Desktop background (for empty workspaces).
# https://faq.i3wm.org/question/6/how-can-i-set-a-desktop-background-image-in-i3/
# The 10 second delay between starting compton and applying the
# desktop background avoids screen corruption on my machine.
exec --no-startup-id compton -b &
exec --no-startup-id sleep 10s && nitrogen --restore &

# Try to ensure dropbox starts cleanly without impacting anything else.
exec --no-startup-id dropbox stop &
exec --no-startup-id sleep 1.5 && killall --quiet dropbox &
exec --no-startup-id sleep 3 && dbus-launch dropbox start -i &
# Try to ensure xfce4-panel starts once only lest dialogs appear.
exec --no-startup-id xfce4-panel

# Applications.
# The 10 second delay ensures that the dialog appears after the
# desktop background changes.
exec --no-startup-id sleep 10s && $i3apps start everything

#
# Done
#
